server:
  port: 8000

spring:
  application:
    name: gateway-service
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        # 用户服务路由
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/user/**
          filters:
            - StripPrefix=1

        # AI审查服务路由
        - id: ai-review-service
          uri: lb://ai-review-service
          predicates:
            - Path=/api/review/**
          filters:
            - StripPrefix=1

      # 全局跨域配置
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOriginPatterns: "*"
            allowed-methods: "*"
            allowed-headers: "*"
            allow-credentials: true
            max-age: 3600

    sentinel:
      transport:
        dashboard: localhost:8090
        port: 8719

management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    health:
      show-details: always
    prometheus:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
      service: ${spring.application.name}
    export:
      prometheus:
        enabled: true

# API 限流配置
rate-limit:
  enabled: true
  # 默认限流规则
  default-rule:
    window-seconds: 60
    max-requests: 100
    type: IP
  # 路径特定规则
  rules:
    # 代码审查接口 - 更严格的限流
    "/api/review/submit":
      window-seconds: 60
      max-requests: 10
      type: USER
    "/api/review/sync":
      window-seconds: 60
      max-requests: 5
      type: USER
    "/api/review/batch":
      window-seconds: 60
      max-requests: 3
      type: USER
    # 用户登录接口 - 防止暴力破解
    "/api/user/login":
      window-seconds: 60
      max-requests: 10
      type: IP
    "/api/user/register":
      window-seconds: 60
      max-requests: 5
      type: IP
    # 查询接口 - 相对宽松
    "/api/review/tasks":
      window-seconds: 60
      max-requests: 60
      type: USER
    "/api/review/task/**":
      window-seconds: 60
      max-requests: 60
      type: USER

# 日志配置
logging:
  level:
    com.codereview: debug
    # Gateway核心日志
    org.springframework.cloud.gateway: DEBUG
    # LoadBalancer日志
    org.springframework.cloud.loadbalancer: DEBUG
    # Nacos服务发现日志
    com.alibaba.nacos.client: DEBUG
    # Reactor Netty日志
    reactor.netty.http.client: DEBUG
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{50} - %msg%n'
